---
description: 
globs: 
alwaysApply: false
---
# Seed-E Project Status

## âœ… **COMPLETED FEATURES**

### ğŸ” **Authentication System**
- âœ… User registration and login
- âœ… 2FA setup and verification
- âœ… Password reset functionality
- âœ… Recovery key generation and validation
- âœ… Session management with JWT tokens
- âœ… User validation middleware

### ğŸ¢ **Provider Dashboard**
- âœ… Provider registration and management
- âœ… Policy creation and management
- âœ… Signature request handling
- âœ… Key management interface
- âœ… **Import Key Modal with QR Scanner Integration**
  - âœ… Hardware and software device categories
  - âœ… Multi-step import flow with method selection
  - âœ… **Direct import for single-method devices** (e.g., SeedSigner goes straight to QR)
  - âœ… **QR Scanner with camera and file upload support**
  - âœ… **SeedSigner format parsing** (master fingerprint, derivation path, xpub)
  - âœ… **UR and BBQR format support**
  - âœ… **Form validation for all xpub variants** (xpub, Xpub, ypub, Ypub, zpub, Zpub)
- âœ… **Sign Message Modal with PSBT Creation**
  - âœ… **Proper bitcoinjs-lib integration** for real PSBT creation
  - âœ… **OP_RETURN output** containing the message "Seed-E"
  - âœ… **BIP32 derivation info** for SeedSigner compatibility
  - âœ… **QR code generation** for PSBT scanning
  - âœ… **Two-step process**: QR scan â†’ signature input
  - âœ… **Form integration** with control signature field

### ğŸ’° **Client Dashboard**
- âœ… Service browsing and purchase
- âœ… Lightning payment integration
- âœ… Signature request creation
- âœ… PSBT upload and management
- âœ… Payment status tracking

### âš¡ **Lightning Network Integration**
- âœ… LND node integration
- âœ… Lightning address support
- âœ… Payment webhook handling
- âœ… Invoice generation and validation

### ğŸ”§ **Backend Services**
- âœ… Prisma database with migrations
- âœ… User authentication and authorization
- âœ… Service policy management
- âœ… Signature request processing
- âœ… Payment validation and confirmation

## ğŸš§ **IN PROGRESS**

### ğŸ”‘ **Add Key Form - Control Signature Validation**
- âœ… **Sign Message Modal** - Complete with proper PSBT creation
- âœ… **QR Code Generation** - Working with bitcoinjs-lib
- âœ… **Form Integration** - Connected to control signature field
- ğŸ”„ **Backend Validation** - Need to update to handle PSBT signatures instead of message signatures
- ğŸ”„ **Signature Verification** - Need to verify PSBT signatures against xpub

## ğŸ“‹ **TODO - Add Key Form**

### **Remaining Tasks:**
1. **Backend PSBT Validation** - Update `/api/providers/validate-signature` to:
   - Accept PSBT data instead of hex signatures
   - Parse PSBT and extract signatures
   - Verify signatures against the xpub using bitcoinjs-lib
   - Validate that the PSBT contains the expected "Seed-E" message

2. **PSBT Signature Verification** - Implement proper signature verification:
   - Extract public key from xpub
   - Verify signature against the message hash
   - Handle different signature formats (DER, etc.)

3. **Error Handling** - Add proper error messages for:
   - Invalid PSBT format
   - Missing signatures
   - Signature verification failures
   - Wrong message content

4. **Testing** - Test the complete flow:
   - Generate PSBT with "Seed-E" message
   - Sign with SeedSigner
   - Submit signed PSBT
   - Verify signature on backend
   - Complete form submission

## ğŸ¯ **CURRENT STATUS**

The **Add Key Form** is **90% complete**:
- âœ… **Import Key Modal** - Fully functional with QR scanning
- âœ… **Sign Message Modal** - Complete with proper PSBT creation
- âœ… **Form Validation** - All fields validated
- ğŸ”„ **Control Signature** - Modal works, backend validation needed
- â³ **Final Integration** - Backend PSBT validation pending

**Next Steps:**
1. Update backend signature validation to handle PSBTs
2. Test complete flow with SeedSigner
3. Deploy and test in production environment

## ğŸ—ï¸ **TECHNICAL ARCHITECTURE**

### **Frontend Components:**
- `ImportKeyModal.tsx` - QR scanning and key import
- `SignMessageModal.tsx` - PSBT creation and signature collection
- `provider-dashboard/page.tsx` - Main provider interface

### **Backend APIs:**
- `/api/providers/validate-signature` - Signature validation (needs PSBT support)
- `/api/providers/route.ts` - Provider management
- `/api/signature-requests/*` - Signature request handling

### **Libraries Used:**
- `bitcoinjs-lib` - PSBT creation and manipulation
- `tiny-secp256k1` - Cryptographic operations
- `qrcode.react` - QR code generation
- `@ngraveio/bc-ur` - UR format support

## ğŸš€ **DEPLOYMENT READY**

The application is ready for deployment with:
- âœ… Complete authentication system
- âœ… Provider and client dashboards
- âœ… Lightning payment integration
- âœ… QR code scanning and generation
- âœ… PSBT creation and handling
- ğŸ”„ Final signature validation integration pending
